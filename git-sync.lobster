name: "Workspace Git Backup & Sync"
description: "å®‰å…¨åœ°å°† OpenClaw Workspace çš„é…ç½®å˜æ›´å¤‡ä»½åˆ°è¿œç¨‹ Git ä»“åº“"
version: "1.0"
author: "æ—å“¥"

# å…¨å±€é…ç½®
config:
  workspace_dir: "~/.openclaw/workspace"
  git_remote: "origin"
  git_branch: "main"
  timeout_ms: 30000

steps:
  # ============================================
  # æ­¥éª¤ 1: æ£€æŸ¥ Git çŠ¶æ€
  # ============================================
  - name: check_git_status
    description: "æ£€æŸ¥æœ¬åœ° git çŠ¶æ€å¹¶è·å–å˜æ›´åˆ—è¡¨"
    run: exec --json --shell "git -C {{config.workspace_dir}} status --porcelain"
    timeoutMs: 10000
    on_error:
      - run: notify-user --message "âŒ Git çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¡®è®¤å·¥ä½œåŒºå·²åˆå§‹åŒ– Git"
      - exit: 1

  # ============================================
  # æ­¥éª¤ 2: å¦‚æœæœ‰å˜æ›´ï¼Œè·å–è¯¦ç»† diff
  # ============================================
  - name: get_diff
    description: "è·å–è¯¦ç»†çš„æ–‡ä»¶å˜æ›´å†…å®¹"
    run: exec --json --shell "git -C {{config.workspace_dir}} diff --stat"
    timeoutMs: 10000
    condition: "$check_git_status.stdout != ''"

  # ============================================
  # æ­¥éª¤ 3: ä½¿ç”¨ LLM æ€»ç»“å˜æ›´å†…å®¹
  # ============================================
  - name: summarize_changes
    description: "è®© AI åˆ†æå˜æ›´å¹¶ç”Ÿæˆ commit message"
    run: llm-task --prompt "åˆ†æä»¥ä¸‹ Git å˜æ›´ï¼Œç”¨ä¸€å¥è¯æ€»ç»“ä¿®æ”¹å†…å®¹ï¼ˆä¸­æ–‡ï¼‰ï¼š\n{{get_diff.stdout}}"
    stdin: $get_diff.stdout
    timeoutMs: 30000
    condition: "$get_diff.success == true"

  # ============================================
  # æ­¥éª¤ 4: äººå·¥å®¡æ‰¹é—¨ï¼ˆé˜²è¯¯è¦†ç›–ï¼‰
  # ============================================
  - name: human_review
    description: "ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ˜¯å¦æäº¤å˜æ›´"
    needs_approval: true
    preview: |
      ğŸ“‹ å‘ç°é…ç½®å˜æ›´ï¼Œç¡®è®¤æäº¤åˆ° GitHubï¼Ÿ
      
      å˜æ›´æ‘˜è¦ï¼š{{summarize_changes.text}}
      
      å˜æ›´æ–‡ä»¶ï¼š
      {{check_git_status.stdout}}
      
      [âœ… æ‰¹å‡†æäº¤] [âŒ æ‹’ç»]
    timeoutMs: 3600000  # 1 å°æ—¶è¶…æ—¶

  # ============================================
  # æ­¥éª¤ 5: Git Add + Commit
  # ============================================
  - name: git_commit
    description: "æ‰§è¡Œ Git æ·»åŠ å’Œæäº¤"
    run: exec --shell "git -C {{config.workspace_dir}} add . && git -C {{config.workspace_dir}} commit -m '{{summarize_changes.text}}'"
    condition: "$human_review.approved == true"
    timeoutMs: 30000

  # ============================================
  # æ­¥éª¤ 6: Git Push åˆ°è¿œç¨‹ä»“åº“
  # ============================================
  - name: git_push
    description: "å°†å˜æ›´æ¨é€åˆ°è¿œç¨‹ GitHub ä»“åº“"
    run: exec --shell "git -C {{config.workspace_dir}} push {{config.git_remote}} {{config.git_branch}}"
    condition: "$git_commit.success == true"
    timeoutMs: 60000
    on_error:
      - run: notify-user --message "âŒ Git Push å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ SSH å¯†é’¥"
      - exit: 1

  # ============================================
  # æ­¥éª¤ 7: æ›´æ–°æ¸¸æ ‡çŠ¶æ€
  # ============================================
  - name: update_cursor
    description: "è®°å½•æœ¬æ¬¡åŒæ­¥çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤å¤„ç†"
    run: exec --shell "echo '{\"last_sync\": \"$(date -Iseconds)\", \"commit\": \"$(git -C {{config.workspace_dir}} rev-parse HEAD)\"}' > ~/.lobster/state/git-sync.cursor.json"
    condition: "$git_push.success == true"

  # ============================================
  # æ­¥éª¤ 8: é€šçŸ¥ç”¨æˆ·åŒæ­¥å®Œæˆ
  # ============================================
  - name: notify_complete
    description: "å‘ç”¨æˆ·å‘é€åŒæ­¥å®Œæˆé€šçŸ¥"
    run: notify-user --message "âœ… Workspace åŒæ­¥å®Œæˆï¼\n\næäº¤ä¿¡æ¯ï¼š{{summarize_changes.text}}\nCommit: $(git -C {{config.workspace_dir}} rev-parse --short HEAD)"
    condition: "$update_cursor.success == true"

# ============================================
# é”™è¯¯å¤„ç†ï¼šæ— å˜æ›´æ—¶çš„å¤„ç†
# ============================================
- name: no_changes
  description: "å¦‚æœæ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡åŒæ­¥"
  run: notify-user --message "âœ… Workspace é…ç½®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
  condition: "$check_git_status.stdout == ''"
